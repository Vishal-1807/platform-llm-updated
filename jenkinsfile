pipeline {
    agent {
        docker {
            image 'node:18-bullseye'
            args '-u root'
        }
    }
    
    environment {
        AZURE_SERVICE_PRINCIPAL_ID     = credentials('azure-sp-client-id')
        AZURE_SERVICE_PRINCIPAL_SECRET = credentials('azure-sp-client-secret')
        AZURE_TENANT_ID                = credentials('azure-sp-tenant-id')
        AZURE_SUBSCRIPTION_ID          = credentials('azure-subscription-id')
        STORAGE_ACCOUNT_NAME           = 'awonefrontendstatic12312'
        BUILD_DIR                     = 'dist'
    }
    
    stages {
        stage('Install Azure CLI') {
            steps {
                echo 'Installing Azure CLI'
                sh '''
                    # Install required dependencies
                    apt-get update
                    apt-get install -y curl gnupg lsb-release
                    
                    # Install Azure CLI
                    curl -sL https://aka.ms/InstallAzureCLIDeb | bash
                    
                    # Verify installation
                    az --version
                '''
            }
        }
        
        stage('Fix Case Sensitivity') {
            steps {
                sh '''
                    cd src/components/Tabular/Experiment/Deploy/Endpoint/
                    ln -sf Endpoint.css EndPoint.css 2>/dev/null || true
                '''
            }
        }
        
        stage('Build') {
            steps {
                sh 'npm install'
                sh 'npm run build'
            }
        }

        stage('Deploy to Azure Storage') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'azure-sp-client-id',
                            usernameVariable: 'AZURE_CLIENT_ID',
                            passwordVariable: 'AZURE_CLIENT_SECRET'
                        )
                    ]) {
                        sh """
                            az login --service-principal \
                                -u ${AZURE_SERVICE_PRINCIPAL_ID} \
                                -p ${AZURE_SERVICE_PRINCIPAL_SECRET} \
                                --tenant ${AZURE_TENANT_ID}
                            
                            az account set --subscription ${AZURE_SUBSCRIPTION_ID}                            
                            # Upload files
                            az storage blob upload-batch \
                                --account-name ${STORAGE_ACCOUNT_NAME} \
                                --destination '\$web' \
                                --source ${BUILD_DIR} \
                                --overwrite
                        """
                    }
                }
            }
        }
    }
}
