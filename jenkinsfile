pipeline {
    agent {
        docker {
            image 'node:18-bullseye'
            args '-u root'
        }
    }
    
    environment {
        AZURE_SERVICE_PRINCIPAL_ID     = credentials('azure-sp-client-id')
        AZURE_SERVICE_PRINCIPAL_SECRET = credentials('azure-sp-client-secret')
        AZURE_TENANT_ID                = credentials('azure-sp-tenant-id')
        AZURE_SUBSCRIPTION_ID          = credentials('azure-subscription-id')
        STORAGE_ACCOUNT_NAME           = 'awonefrontendstatic12312'
        BUILD_DIR                     = 'dist'
    }
    
    stages {
        stage('Clean Workspace') {
            steps {
                sh '''
                    echo "Cleaning workspace before checkout..."
                    # Remove any existing dist folder that might cause permission issues
                    rm -rf dist/ || true
                    ls -la
                '''
            }
        }
        
        stage('Install Azure CLI') {
            steps {
                echo 'Installing Azure CLI'
                sh '''
                    # Install required dependencies
                    apt-get update
                    apt-get install -y curl gnupg lsb-release
                    
                    # Install Azure CLI
                    curl -sL https://aka.ms/InstallAzureCLIDeb | bash
                    
                    # Verify installation
                    az --version
                '''
            }
        }
        
        stage('Fix Case Sensitivity') {
            steps {
                sh '''
                    echo "Fixing CSS import case sensitivity..."
                    cd src/components/Tabular/Experiment/Deploy/Endpoint/
                    ln -sf Endpoint.css EndPoint.css 2>/dev/null || true
                    echo "Case sensitivity fix applied"
                '''
            }
        }
        
        stage('Build') {
            steps {
                sh '''
                    echo "Installing dependencies..."
                    npm install
                    
                    echo "Building project..."
                    npm run build
                    
                    echo "Verifying dist folder creation..."
                    if [ -d "dist" ]; then
                        echo "SUCCESS: dist folder created!"
                        echo "Dist folder contents:"
                        ls -la dist/
                        echo "Number of files in dist: $(find dist/ -type f | wc -l)"
                    else
                        echo "ERROR: dist folder was not created by build process"
                        echo "Current directory contents:"
                        ls -la
                        exit 1
                    fi
                '''
            }
        }

        stage('Deploy to Azure Storage') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'azure-sp-client-id',
                            usernameVariable: 'AZURE_CLIENT_ID',
                            passwordVariable: 'AZURE_CLIENT_SECRET'
                        )
                    ]) {
                        sh """
                            echo "Starting Azure deployment..."
                            az login --service-principal \
                                -u ${AZURE_SERVICE_PRINCIPAL_ID} \
                                -p ${AZURE_SERVICE_PRINCIPAL_SECRET} \
                                --tenant ${AZURE_TENANT_ID}
                            
                            az account set --subscription ${AZURE_SUBSCRIPTION_ID}
                            
                            echo "Uploading files from dist folder to Azure Storage..."
                            az storage blob upload-batch \
                                --account-name ${STORAGE_ACCOUNT_NAME} \
                                --destination '\$web' \
                                --source ${BUILD_DIR} \
                                --overwrite
                            
                            echo "Deployment completed successfully!"
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "Build pipeline execution completed"
        }
        success {
            echo "SUCCESS: Build and deployment completed successfully!"
        }
        failure {
            echo "FAILURE: Build or deployment failed - check logs above"
        }
    }
}
